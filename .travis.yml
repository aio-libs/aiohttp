sudo: false
services:
  - docker

language: python

addons:
  apt:
    packages:
    - enchant

# doesn't work on MacOSX out of the box -- the system has no Python installed
# there's a workaround to use `language: generic` and install it, but it's slow
os: linux

jobs:
  fast_finish: true
  allow_failures:
  - python: 3.6-dev
  - python: nightly

  include:
  # python3.4.2 has bug in http.cookies module, aiohttp provides fix
  - python: 3.4.2
  - python: 3.4.3
  - python: 3.5.2
  # - 3.5.3
  - python: 3.5
  - python: &mainstream_python 3.6
  - python: 3.6-dev
  - python: nightly

  - stage: deploy (PYPI upload itself runs only for tagged commits)
    python: *mainstream_python
    install: skip
    script: skip
    after_success: skip
    deploy:
      provider: pypi
      user: andrew.svetlov
      password:
        secure: ZQKbdPT9BlNqP5CTbWRQyeyig7Bpf7wsnYVQIQPOZc9Ec74A+dsbagstR1sPkAO+d+5PN0pZMovvmU7OQhSVPAnJ74nsN90/fL4ux3kqYecMbevv0rJg20hMXSSkwMEIpjUsMdMjJvZAcaKytGWmKL0qAlOJHhixd1pBbWyuIUE=
      distributions: sdist
      on:
        tags: true
        all_branches: true

cache: pip

before_cache: rm -f $HOME/.cache/pip/log/debug.log

install:
  - pip install --upgrade pip wheel
  - pip install --upgrade setuptools
  - pip install --upgrade setuptools-git
  - pip install -r requirements/ci.txt
  - pip install aiodns
  - pip install codecov
  - pip install 'uvloop; python_version>="3.5"'
  - pip install sphinxcontrib-spelling

script:
  - make cov-dev-full

  - if python -c "import sys; sys.exit(sys.version_info < (3,5))"; then
        make doc;
        make doc-spelling;
    fi

after_success:
  - codecov
  - ./tools/run_docker.sh "aiohttp"
