Simplify middleware

So they are simple coroutines rather than coroutine factories
returning coroutines.
